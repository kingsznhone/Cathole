# CatHole æ¶æ„è®¾è®¡

## ğŸ“ è®¾è®¡ç†å¿µ

CatHole é‡‡ç”¨**åˆ†å±‚æ¶æ„**è®¾è®¡ï¼Œå°†æ ¸å¿ƒåŠŸèƒ½ä¸æ¡†æ¶é›†æˆåˆ†ç¦»ï¼Œå®ç°**æ¡†æ¶æ— å…³**çš„å¯å¤ç”¨ç»„ä»¶ã€‚

---

## ğŸ—ï¸ æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Application Layer (åº”ç”¨å±‚)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Console App        â”‚  â”‚  ASP.NET Core / WinSvc  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Integration Layer (é›†æˆå±‚ - CatHole)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ RelayService     â”‚  â”‚  RelayHostedService       â”‚  â”‚
â”‚  â”‚ (é…ç½®åŠ è½½)        â”‚  â”‚  (IHostedService å®ç°)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Core Layer (æ ¸å¿ƒå±‚ - CatHole.Core)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  RelayManager    â”‚  â”‚    RelayFactory           â”‚  â”‚
â”‚  â”‚  (ç”Ÿå‘½å‘¨æœŸç®¡ç†)   â”‚  â”‚    (å·¥å‚/æ„å»ºå™¨)           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Relay           â”‚  â”‚    RelayOption            â”‚  â”‚
â”‚  â”‚  (è½¬å‘å®ä¾‹)       â”‚  â”‚    (é…ç½®æ¨¡å‹)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ æ ¸å¿ƒç»„ä»¶

### 1. **Relay** - è½¬å‘å®ä¾‹
**èŒè´£**: æ‰§è¡Œå•ä¸ªç«¯å£è½¬å‘ä»»åŠ¡
- TCP/UDP åè®®å¤„ç†
- è¿æ¥ç®¡ç†å’Œæµå¤åˆ¶
- èµ„æºæ¸…ç†

**ç‰¹ç‚¹**:
- ç‹¬ç«‹è¿è¡Œ
- æ”¯æŒ TCP åŠå…³é—­
- UDP tunnel è‡ªåŠ¨è¶…æ—¶

---

### 2. **RelayManager** - ç®¡ç†å™¨
**èŒè´£**: ç®¡ç†å¤šä¸ª Relay å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸ
- æ·»åŠ /ç§»é™¤/æŸ¥è¯¢ Relay
- æ‰¹é‡æ“ä½œï¼ˆå¯åŠ¨/åœæ­¢/æ¸…ç†ï¼‰
- çº¿ç¨‹å®‰å…¨çš„å¹¶å‘ç®¡ç†

**ç‰¹ç‚¹**:
- âœ… æ¡†æ¶æ— å…³
- âœ… å®ç° `IDisposable` å’Œ `IAsyncDisposable`
- âœ… çº¿ç¨‹å®‰å…¨ï¼ˆä½¿ç”¨ `ConcurrentDictionary` å’Œ `Lock`ï¼‰

**API**:
```csharp
public class RelayManager : IDisposable, IAsyncDisposable
{
    bool AddRelay(RelayOption option)
    int AddRelays(IEnumerable<RelayOption> options)
    Task<bool> RemoveRelayAsync(string name)
    bool TryGetRelay(string name, out Relay? relay)
    void StartAll()
    Task StopAllAsync()
    Task ClearAsync()
    bool Contains(string name)
}
```

---

### 3. **RelayFactory** - å·¥å‚ç±»
**èŒè´£**: åˆ›å»ºå’ŒéªŒè¯ Relay å®ä¾‹
- é…ç½®éªŒè¯
- å®ä¾‹åˆ›å»º
- æä¾›æ„å»ºå™¨æ¨¡å¼

**ç‰¹ç‚¹**:
- âœ… ä¸¥æ ¼éªŒè¯ï¼ˆç«¯å£æ ¼å¼ã€å‚æ•°èŒƒå›´ï¼‰
- âœ… å‹å¥½çš„é”™è¯¯æç¤º
- âœ… Fluent APIï¼ˆé“¾å¼è°ƒç”¨ï¼‰

**API**:
```csharp
public class RelayFactory
{
    Relay CreateRelay(RelayOption option)
    static void ValidateOption(RelayOption option)
    static RelayBuilder CreateBuilder(ILoggerFactory)
}

public class RelayBuilder
{
    RelayBuilder WithName(string name)
    RelayBuilder ListenOn(string host)
    RelayBuilder ForwardTo(string host)
    RelayBuilder EnableTCP(bool enabled = true)
    RelayBuilder EnableUDP(bool enabled = true)
    RelayBuilder TCPOnly()
    RelayBuilder UDPOnly()
    Relay Build()
}
```

---

### 4. **RelayOption** - é…ç½®æ¨¡å‹
**èŒè´£**: å°è£… Relay é…ç½®å‚æ•°

**å±æ€§**:
```csharp
public class RelayOption
{
    string Name          // Relay åç§°
    string ListenHost    // ç›‘å¬åœ°å€ (IP:Port)
    string TargetHost    // ç›®æ ‡åœ°å€ (IP:Port)
    bool TCP             // å¯ç”¨ TCP
    bool UDP             // å¯ç”¨ UDP
    int BufferSize       // ç¼“å†²åŒºå¤§å°
    int Timeout          // è¶…æ—¶æ—¶é—´(ms)
}
```

---

### 5. **RelayService** - ASP.NET Core æœåŠ¡
**èŒè´£**: ASP.NET Core é›†æˆé€‚é…å™¨
- ä» `IConfiguration` åŠ è½½é…ç½®
- å°è£… `RelayManager`
- æä¾›ä¾¿æ·çš„å¯åŠ¨/åœæ­¢æ–¹æ³•

**ç‰¹ç‚¹**:
- âœ… è‡ªåŠ¨ä» `appsettings.json` åŠ è½½
- âœ… æš´éœ² `Manager` å±æ€§ä¾›é«˜çº§æ“ä½œ
- âœ… ç®€åŒ–çš„ API

---

### 6. **RelayHostedService** - IHostedService å®ç°
**èŒè´£**: æ ‡å‡†çš„ ASP.NET Core Hosted Service
- åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨ Relay
- åº”ç”¨å…³é—­æ—¶ä¼˜é›…åœæ­¢
- å®Œå…¨é›†æˆç”Ÿå‘½å‘¨æœŸ

**ç‰¹ç‚¹**:
- âœ… å®ç° `IHostedService`
- âœ… è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âœ… å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—

---

## ğŸ¯ è®¾è®¡ä¼˜åŠ¿

### 1. **æ¡†æ¶æ— å…³çš„æ ¸å¿ƒ**
```csharp
// CatHole.Core ä¸ä¾èµ–ä»»ä½•ç‰¹å®šæ¡†æ¶
// åªä¾èµ–ï¼š
// - Microsoft.Extensions.Logging.Abstractions
// - System.Net.Sockets
// - System.Collections.Concurrent
```

**ä¼˜åŠ¿**: å¯ä»¥åœ¨ä»»ä½• .NET åº”ç”¨ä¸­ä½¿ç”¨ï¼ˆConsoleã€WinFormsã€WPFã€Xamarinã€Unity ç­‰ï¼‰

---

### 2. **èŒè´£åˆ†ç¦»**
| ç»„ä»¶ | èŒè´£ | ä¾èµ– |
|------|------|------|
| `Relay` | è½¬å‘é€»è¾‘ | æ—  |
| `RelayManager` | ç”Ÿå‘½å‘¨æœŸç®¡ç† | Relay |
| `RelayFactory` | åˆ›å»ºå’ŒéªŒè¯ | Relay |
| `RelayService` | é…ç½®åŠ è½½ | RelayManager + IConfiguration |
| `RelayHostedService` | ç”Ÿå‘½å‘¨æœŸé›†æˆ | RelayManager + IHostedService |

---

### 3. **çµæ´»çš„ä½¿ç”¨æ–¹å¼**

#### æ–¹å¼ A: ç›´æ¥ä½¿ç”¨ Relay
```csharp
var relay = new Relay(option, logger);
relay.Start();
// ...
await relay.StopAsync();
```

#### æ–¹å¼ B: ä½¿ç”¨ RelayManager
```csharp
using var manager = new RelayManager(loggerFactory);
manager.AddRelay(option);
// ...
await manager.StopAllAsync();
```

#### æ–¹å¼ C: ä½¿ç”¨ Builder
```csharp
var relay = RelayFactory.CreateBuilder(loggerFactory)
    .WithName("Test")
    .ListenOn("127.0.0.1:8080")
    .ForwardTo("192.168.1.100:80")
    .TCPOnly()
    .Build();
```

#### æ–¹å¼ D: ASP.NET Core HostedService
```csharp
builder.Services.AddHostedService<RelayHostedService>();
```

---

## ğŸ”’ çº¿ç¨‹å®‰å…¨

### å¹¶å‘ä¿æŠ¤æªæ–½

1. **RelayManager**
   - ä½¿ç”¨ `ConcurrentDictionary<string, Relay>` å­˜å‚¨ Relay
   - ä½¿ç”¨ `Lock` ä¿æŠ¤ç®¡ç†æ“ä½œ
   - æ‰€æœ‰å…¬å¼€æ–¹æ³•çº¿ç¨‹å®‰å…¨

2. **Relay**
   - ä½¿ç”¨ `ConcurrentBag<Task>` è·Ÿè¸ªä»»åŠ¡
   - ä½¿ç”¨ `ConcurrentDictionary<IPEndPoint, UdpTunnelInfo>` ç®¡ç† UDP tunnel
   - ä½¿ç”¨ `Interlocked` å’Œ `Lock` ä¿æŠ¤çŠ¶æ€

---

## ğŸ“ˆ æ‰©å±•æ€§

### æœªæ¥æ‰©å±•ç‚¹

1. **è‡ªå®šä¹‰åè®®æ”¯æŒ**
   ```csharp
   public interface IProtocolHandler
   {
       Task ForwardAsync(Stream source, Stream target, CancellationToken ct);
   }
   ```

2. **ä¸­é—´ä»¶ç®¡é“**
   ```csharp
   relay.UseMiddleware<LoggingMiddleware>();
   relay.UseMiddleware<RateLimitMiddleware>();
   relay.UseMiddleware<EncryptionMiddleware>();
   ```

3. **æ’ä»¶ç³»ç»Ÿ**
   ```csharp
   public interface IRelayPlugin
   {
       void OnConnectionStart(ConnectionInfo info);
       void OnConnectionEnd(ConnectionInfo info);
       void OnDataTransfer(DataInfo info);
   }
   ```

4. **é…ç½®æä¾›è€…**
   ```csharp
   public interface IRelayConfigProvider
   {
       Task<IEnumerable<RelayOption>> LoadAsync();
       Task SaveAsync(IEnumerable<RelayOption> options);
   }
   ```

---

## ğŸ§ª å¯æµ‹è¯•æ€§

### ä¾èµ–æ³¨å…¥å‹å¥½

```csharp
// å•å…ƒæµ‹è¯•
var loggerFactory = NullLoggerFactory.Instance;
using var manager = new RelayManager(loggerFactory);

// Mock é…ç½®
var mockConfig = new Mock<IConfiguration>();
var service = new RelayService(mockConfig.Object, logger, loggerFactory);
```

### æ¥å£åˆ†ç¦»

```csharp
// æœªæ¥å¯ä»¥æå–æ¥å£
public interface IRelayManager
{
    bool AddRelay(RelayOption option);
    Task<bool> RemoveRelayAsync(string name);
    Task StopAllAsync();
}
```

---

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### 1. **é›¶æ‹·è´ä¼˜åŒ–**ï¼ˆå·²å®ç°ï¼‰
- ä½¿ç”¨ `Memory<byte>` å’Œ `ReadOnlyMemory<byte>`
- é¿å…ä¸å¿…è¦çš„å†…å­˜åˆ†é…

### 2. **ä»»åŠ¡æ± åŒ–**ï¼ˆæœªæ¥ï¼‰
- ä½¿ç”¨ `ObjectPool<T>` å¤ç”¨å¯¹è±¡
- å‡å°‘ GC å‹åŠ›

### 3. **ç¼“å†²åŒºç®¡ç†**ï¼ˆæœªæ¥ï¼‰
- ä½¿ç”¨ `ArrayPool<byte>` ç®¡ç†ç¼“å†²åŒº
- å¯é…ç½®çš„ç¼“å†²åŒºå¤§å°

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ä¾èµ–æ³¨å…¥
```csharp
services.AddSingleton<RelayManager>();
services.AddHostedService<RelayHostedService>();
```

### 2. æ­£ç¡®å¤„ç†ç”Ÿå‘½å‘¨æœŸ
```csharp
// âœ… æ¨è
await using var manager = new RelayManager(loggerFactory);

// âŒ é¿å…
var manager = new RelayManager(loggerFactory);
// å¿˜è®° dispose
```

### 3. é”™è¯¯å¤„ç†
```csharp
try
{
    manager.AddRelay(option);
}
catch (ArgumentException ex)
{
    // é…ç½®é”™è¯¯
    logger.LogError(ex, "Invalid configuration");
}
catch (Exception ex)
{
    // å…¶ä»–é”™è¯¯
    logger.LogError(ex, "Failed to add relay");
}
```

---

## ğŸ“ æ€»ç»“

CatHole çš„æ¶æ„è®¾è®¡éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

âœ… **å•ä¸€èŒè´£** - æ¯ä¸ªç»„ä»¶èŒè´£æ˜ç¡®  
âœ… **å¼€æ”¾å°é—­** - æ˜“äºæ‰©å±•ï¼Œä¸éœ€ä¿®æ”¹æ ¸å¿ƒ  
âœ… **ä¾èµ–å€’ç½®** - ä¾èµ–æŠ½è±¡ï¼ˆILoggerï¼‰ï¼Œä¸ä¾èµ–å…·ä½“å®ç°  
âœ… **æ¥å£éš”ç¦»** - æœ€å°åŒ–ä¾èµ–ï¼Œæ¡†æ¶æ— å…³  
âœ… **é‡Œæ°æ›¿æ¢** - ç»„ä»¶å¯ä»¥ç‹¬ç«‹ä½¿ç”¨æˆ–ç»„åˆä½¿ç”¨  

è¿™ä½¿å¾— CatHole æˆä¸ºä¸€ä¸ª**é«˜åº¦å¯å¤ç”¨ã€æ˜“äºæµ‹è¯•ã€ä¾¿äºç»´æŠ¤**çš„ç«¯å£è½¬å‘åº“ã€‚
